# Makefile for ncgen(1).
#
# $Id$

PROGRAM		= ncgen
BINFILES	= $(PROGRAM)
CPP_NETCDF	= -I../libsrc
CPPFLAGS	= $(CPP_NETCDF) @CPPFLAGS@
CFLAGS		= @CFLAGS@ @HDF_INC@
FFLAGS		= @FFLAGS@
MANUALS		= ncgen.1
GARBAGE		= $(PROGRAM) \
		  ncgenyy.c ncgentab.c ncgentab.h \
		  test0.nc test1.nc test1.cdl test2.cdl test0.f ctest0 \
		  ftest0 ftest0.nc ftest1.cdl test0.c ctest0.nc ctest1.cdl
MANIFEST	= Makefile.in depend README \
		  close.c descrip.mms escapes.c generate.c generic.h \
		  genlib.c genlib.h getfill.c init.c lexyacc.com load.c \
		  main.c make.com msoft.mk msofttab.c msofttab.h \
		  msoftyy.c ncgen.1 ncgen.h ncgen.l ncgen.opt ncgen.y \
		  test.com test0.cdl
LIBNAME		= netcdf
LD_NETCDF	= -L../libsrc -l$(LIBNAME)
OBJS		= main.o generate.o load.o ncgentab.o escapes.o \
		  getfill.o init.o close.o genlib.o
LD_XDR		= @LD_XDR@
LD_NETCDF	= -L../libsrc -lnetcdf
LIBS		= $(LD_NETCDF) $(LD_XDR) @HDF_LIB@
LEX		= @LEX@
YACC		= @YACC@
prefix		= ../../..

all::		$(PROGRAM)

test:           $(PROGRAM) test0.cdl btest ctest FORCE
	@if [ -n "$(FC)" ]; then \
	    $(MAKE) $(MFLAGS) NCDUMP=$(NCDUMP) ftest; \
	else \
	    echo "\`ftest' not made because the make(1)-macro for" \
		"the FORTRAN compiler (FC) is empty"; \
	fi

install::	installed_program installed_manuals

$(PROGRAM):	main.o

ncgentab.c \
ncgentab.h:	ncgen.y ncgenyy.c ncgen.h
	$(YACC) -d ncgen.y
	mv y.tab.c ncgentab.c
	mv y.tab.h ncgentab.h

ncgenyy.c:	ncgen.l
	$(LEX) ncgen.l
	mv lex.yy.c ncgenyy.c

#
# test "-b" option of ncgen
#
btest:		$(PROGRAM) test0.cdl test1.cdl
	./$(PROGRAM) -b test1.cdl
	$(NCDUMP) test1.nc > test2.cdl
	@diff test1.cdl test2.cdl && \
	    echo "*** $(PROGRAM) -b test successful ***"

#
# test "-c" option of ncgen
#
ctest:		test1.cdl ctest0
	./ctest0		# tests `-c' option, creates ctest0.nc
	$(NCDUMP) -n test1 ctest0.nc > ctest1.cdl
	@diff test1.cdl ctest1.cdl && \
	    echo "*** $(PROGRAM) -c test successful ***"

ctest0:		ncgen test0.cdl
	./$(PROGRAM) -c -o ctest0.nc test0.cdl > test0.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -o $@ test0.c $(LD_NETCDF) $(LIBS)

#
# test "-f" option of ncgen
#
ftest:		test1.cdl ftest0
	./ftest0		# tests `-f' option, creates ftest0.nc
	$(NCDUMP) -n test1 ftest0.nc > ftest1.cdl
	@if diff test1.cdl ftest1.cdl; then \
	    echo "*** ncgen -f test successful ***"; \
	else \
	    echo "*** ncgen -f test failed " \
		"(but roundoff differences are OK) ***"; \
	fi

ftest0:		$(PROGRAM) test0.cdl netcdf.inc
	./$(PROGRAM) -f -o ftest0.nc test0.cdl > test0.f
	$(FC) $(FFLAGS) -o $@ test0.f $(LD_NETCDF) $(LIBS)

test1.cdl:	test0.nc
	$(NCDUMP) -n test1 test0.nc > $@

test0.nc:	$(PROGRAM) test0.cdl
	./$(PROGRAM) -b -o test0.nc test0.cdl

netcdf.inc:
	ln -s ../fortran/$@ .

msofttab.c : ncgentab.c
	cp $? $@

msofttab.h : ncgentab.h
	cp $? $@

msoftyy.c : ncgenyy.c
	cp $? $@

include ../port/master.mk

# Override the default definition for ncdump(1) in the master makefile.
#
NCDUMP		= ../ncdump/ncdump

### Everything after the following line might be overwritten ###
### DO NOT DELETE THIS LINE.  make depend DEPENDS ON IT ###
include depend
