# Makefile for the FORTRAN interface to the Network CDF library
#
# $Id$

PROGRAM		= ftest
OS		= @OS@
FC		= @FC@
CPP_NETCDF	= -I../libsrc @HDF_INC@
CPP_OLD_FILLVALUES	= @CPP_OLD_FILLVALUES@
CPPFLAGS	= $(CPP_NETCDF) $(CPP_OLD_FILLVALUES) @CPPFLAGS@
CFLAGS		= @CFLAGS@
FFLAGS		= @FFLAGS@
HDF_LIB         = @HDF_LIB@
GARBAGE		= $(PROGRAM) test.nc copy.nc netcdf.inc jackets.c \
		  $(PROGRAM).f test*.hdf hdftest hdfout.new
HEADERS		= netcdf.inc
MANIFEST	= $(PROGRAM).src Makefile.in README aix.m4 common.inc \
		  common.m4 depend descrip.mms fortc fortc1.sed \
		  fortc2.sed hpux.m4 irix.m4 jackets.src msoft.m4 msoft.mk \
		  sunos.m4 ultrix.m4 unicos.m4 vms.m4 \
		  msoft/NOTES msoft/fslen.asm msoft/ftest.for \
		  msoft/jackets.c msoft/msoft.int \
		  msoft/netcdf.inc

LIBOBJS		= jackets.o mfsdf.o mfsdff.o
LIBNAME		= netcdf
LIBRARY		= ../libsrc/lib$(LIBNAME).a
OBJS		= $(PROGRAM).o $(LIBOBJS) 
LD_XDR		= @LD_XDR@
LD_NETCDF	= -L../libsrc -lnetcdf
LIBS		= $(LD_NETCDF) $(LD_XDR) $(HDF_LIB)
prefix		= ../../..

all::		netcdf.inc $(LIBRARY)

test:		FORCE
	@if [ -n "$(FC)" ]; then \
	    $(MAKE) $(MFLAGS) $(PROGRAM); \
	    $(MAKE) $(MFLAGS) hdftest; \
	    ./$(PROGRAM); \
	else \
	    echo "\`$@' not made because FORTRAN macro FC unset"; \
	fi

install::	installed_headers

$(LIBRARY):	$(LIBOBJS)
	$(AR) rcuv $@ $?
	$(RANLIB) $@

$(PROGRAM):	$(PROGRAM).o $(LIBRARY)

jackets.c:	fortc1.sed fortc2.sed common.m4 jackets.src $(OS).m4
	./fortc -L . -O $(OS) jackets.src > $@

netcdf.inc:	common.inc fortc1.sed fortc2.sed common.m4 $(OS).m4
	./fortc -L . -O $(OS) common.inc > $@

$(PROGRAM).f:	fortc1.sed fortc2.sed common.m4 $(PROGRAM).src $(OS).m4
	./fortc -L . -O $(OS) $(PROGRAM).src > $@

hdftest:        hdftest.f $(LIBRARY)
	$(FC) -g hdftest.f $(LIBS) -o $@
	./hdftest > hdfout.new
	@cmd="diff hdfout.new hdftst.sav"; \
	    echo $$cmd; \
	    if $$cmd; then \
		echo "*** HDF passes FORTRAN test ***"; \
	    else \
		echo "*** HDF fails FORTRAN test ***"; \
		echo "The above differences are OK if small"; \
		exit 0; \
	    fi

include ../port/master.mk

$(PROGRAM).o:	netcdf.inc
jackets.o:	../libsrc/netcdf.h

### Everything after the following line might be overwritten ###
### DO NOT DELETE THIS LINE.  make depend DEPENDS ON IT ###
include depend
