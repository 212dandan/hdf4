# Makefile for szip (copied and updated from ../zlib/Makefile.in)

CC=cc

CFLAGS=-O
#CFLAGS=-O -DMAX_WBITS=14 -DMAX_MEM_LEVEL=7
#CFLAGS=-g -DDEBUG
#CFLAGS=-O3 -Wall -Wwrite-strings -Wpointer-arith -Wconversion \
#           -Wstrict-prototypes -Wmissing-prototypes

LDFLAGS=-L. -lsz
LDSHARED=$(CC)
CPP=$(CC) -E

VER=1.0
LIBS=libsz.a
SHAREDLIB=libsz.so

AR=ar
ARFLAGS = rc
RANLIB=ranlib
TAR=tar
SHELL=/bin/sh

TOP_SRCDIR = ../..
#prefix = /usr/local
prefix = $(TOP_SRCDIR)/NewHDF
exec_prefix = ${prefix}
libdir = ${exec_prefix}/lib
includedir = ${prefix}/include

# installation program
INSTALL = ${TOP_SRCDIR}/install-sh -c
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL) -m 644

# ==> specify directories where to find inludes and library
#     HDF library, and HDF utilities
HDFINC= $(srcdir)/../src
HDFLIB= $(srcdir)/../src
HDFBIN= $(srcdir)/../bin

#### makefile fragment from 'config/' goes here ##############
## ------------------------ end of makefile fragments--------------------
HDF_FLAGS       = \
        CC="$(CC)" \
        CFLAGS="$(CFLAGS)" \
        FC="$(FC)" \
        FFLAGS="$(FFLAGS)" \
        RANLIB="$(RANLIB)" \
        AR="$(AR)" \
        ARFLAGS="$(ARFLAGS)" \
        RM="$(RM)" \
        RMFLAGS="$(RMFLAGS)" \
        MACHINE="$(MACHINE)" 

LOCAL_MACROS  = CC="$(CC)" \
	CFLAGS="$(CFLAGS)" \
	CPP="$(CPP)" \
	CPPFLAGS="$(CPPFLAGS)" \
	exec_prefix="$(exec_prefix)" \
	FC="$(FC)" \
	prefix="$(prefix)"


OBJS = sz_api.o rice.o 


EXAMPLE_OBJS = example.o  burst_szip.o mcgill.o
TEST_OBJS = gentest.o mcgill.o 

#all: example burst_szip 
all: gentest  example burst_szip

test: all
	@LD_LIBRARY_PATH=.:$(LD_LIBRARY_PATH) ; export LD_LIBRARY_PATH; \
        echo 'Running SZIP test.....'
	./gentest >gentest.out

libsz.a: $(OBJS) 
	$(AR) $(ARFLAGS) $@ $(OBJS) 
	-@ ($(RANLIB) $@ || true) >/dev/null 2>&1


$(SHAREDLIB).$(VER): $(OBJS)
	$(LDSHARED) -o $@ $(OBJS)
	rm -f $(SHAREDLIB) $(SHAREDLIB).1
	ln -s $@ $(SHAREDLIB)
	ln -s $@ $(SHAREDLIB).1

mcgill.o:
	$(CC) $(CFLAGS) -c mcgill.c

#example: example.o $(LIBS)
#	$(CC) $(CFLAGS) -o $@ example.o $(LDFLAGS)

burst_szip: burst_szip.o $(LIBS) 
	$(CC) $(CFLAGS) -o $@ burst_szip.o mcgill.o -lm

gentest: gentest.o $(LIBS) 
	$(CC) $(CFLAGS) -o $@ gentest.o mcgill.o $(LDFLAGS) -lm

install-lib install: $(LIBS)
	-@if [ ! -d $(includedir)  ]; then mkdir $(includedir); fi
	-@if [ ! -d $(libdir) ]; then mkdir $(libdir); fi
	cp szlib.h szip_adpt.h rice.h ricehdf.h $(includedir)
	chmod 644 $(includedir)/szlib.h $(includedir)/szip_adpt.h $(includedir)/rice*.h
	cp $(LIBS) $(libdir)
	cd $(libdir); chmod 755 $(LIBS)
	-@(cd $(libdir); $(RANLIB) libsz.a || true) >/dev/null 2>&1
	cd $(libdir); if test -f $(SHAREDLIB).$(VER); then \
	  rm -f $(SHAREDLIB) $(SHAREDLIB).1; \
	  ln -s $(SHAREDLIB).$(VER) $(SHAREDLIB); \
	  ln -s $(SHAREDLIB).$(VER) $(SHAREDLIB).1; \
	  (ldconfig || true)  >/dev/null 2>&1; \
	fi
# The ranlib in install is needed on NeXTSTEP which checks file times
# ldconfig is for Linux

uninstall:
	cd $(includedir); \
	v=$(VER); \
	if test -f szlib.h; then \
	  v=`sed -n '/VERSION "/s/.*"\(.*\)".*/\1/p' < szlib.h`; \
          rm -f szlib.h szip_adpt.h rice.h ricehdf.h; \
	fi; \
	cd $(libdir); rm -f libsz.a; \
	if test -f $(SHAREDLIB).$$v; then \
	  rm -f $(SHAREDLIB).$$v $(SHAREDLIB) $(SHAREDLIB).1; \
	fi

clean:
	rm -f *.o *~ example burst_szip mcgill gentest image* libsz.a libsz.so* *.out

distclean:	
	rm -f Makefile *.o *~ example burst_szip mcgill gentest image* libsz.a libsz.so* 


depend:
	makedepend -- $(CFLAGS) -- *.[ch]

# DO NOT DELETE THIS LINE -- make depend depends on it.

#example.o: szlib.h 
gentest.o: szlib.h 
mcgill.o: mcgill.h
rice.o: rice.h
#sz_api.o: szlib.h
burst_szip: mcgill.o
gentest: mcgill.o 
